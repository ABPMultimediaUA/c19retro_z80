ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180), page 1.
Hexadecimal [16-Bits]



                              1 ;;
                              2 ;;  PHYSICS SYSTEM
                              3 ;;
                              4 
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180), page 2.
Hexadecimal [16-Bits]



                              5 .include "../man/entity_manager.h.s"
                              1 ;;
                              2 ;;  ENTITY MANAGER HEADER
                              3 ;;
                              4 
                              5 .globl  man_entity_init
                              6 
                              7 .globl  man_entity_update
                              8 
                              9 .globl  man_entity_create_entity
                             10 .globl  man_entity_create_bomb
                             11 
                             12 .globl  man_entity_get_player
                             13 .globl  man_entity_get_enemy_array
                             14 .globl  man_entity_get_bomb_array
                             15 
                             16 .globl  man_entity_set_player_dead
                             17 .globl  man_entity_set_enemy_dead
                             18 
                             19 ;;########################################################
                             20 ;;                        MACROS                         #              
                             21 ;;########################################################
                             22 
                             23 ;;-----------------------  ENTITY  -----------------------
                             24 .macro DefineEntity _type,_x,_y,_w,_h,_vx,_vy,_sp_ptr_0
                             25     .db _type
                             26     .db _x, _y
                             27     .db _w, _h      ;; both in bytes
                             28     .db _vx, _vy    
                             29     .dw _sp_ptr_0
                             30 .endm
                             31 
                             32 .macro DefineEntityDefault
                             33     .db alive_type
                             34     .db 0xDE, 0xAD
                             35     .db 4, 16  
                             36     .dw 0xADDE 
                             37     .dw 0xCCCC
                             38 .endm
                             39 
                             40 .macro DefineEntityArray _Tname,_N,_DefineEntity
                             41     _Tname'_num:    .db 0    
                             42     _Tname'_last:   .dw _Tname'_array
                             43     _Tname'_array: 
                             44     .rept _N    
                             45         _DefineEntity
                             46     .endm
                             47 .endm
                             48 
                             49 ;;-----------------------  BOMBS  ------------------------
                             50 .macro DefineBombDefault    
                             51     .db max_timer   ;; timer    
                             52     .db 0xDE,0xAD   ;; coordinates (x, y)
                             53     .db #4, #16     ;; width, height -> both in bytes    
                             54     .dw 0xCCCC      ;; sprite  pointer (where it's in memory video)
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180), page 3.
Hexadecimal [16-Bits]



                             55 .endm
                             56 
                             57 .macro DefineBombArray _Tname,_N,_DefineBomb
                             58     _Tname'_num:    .db 0    
                             59     _Tname'_last:   .dw _Tname'_array
                             60     _Tname'_array: 
                             61     .rept _N    
                             62         _DefineBomb
                             63     .endm
                             64 .endm
                             65 
                             66 ;;########################################################
                             67 ;;                       CONSTANTS                       #             
                             68 ;;########################################################
                             69 
                             70 ;;-----------------------  ENTITY  -----------------------
                     0000    71 e_type = 0
                     0001    72 e_x = 1
                     0002    73 e_y = 2
                     0003    74 e_w = 3
                     0004    75 e_h = 4
                     0005    76 e_vx = 5
                     0006    77 e_vy = 6
                     0007    78 e_sp_ptr_0 = 7
                     0007    79 e_sp_ptr_1 = 7
                     0009    80 sizeof_e = 9
                     0001    81 max_entities = 1
                             82 
                             83 ;;-----------------------  BOMBS  ------------------------
                     0000    84 b_timer = 0
                     0001    85 b_x = 1
                     0002    86 b_y = 2
                     0003    87 b_w = 3
                     0004    88 b_h = 4
                     0005    89 b_sp_ptr_0 = 5
                     0006    90 b_sp_ptr_1 = 6
                     0007    91 sizeof_b = 7
                     0001    92 max_bombs = 1
                             93 
                             94 ;;########################################################
                             95 ;;                      ENTITY TYPES                     #             
                             96 ;;########################################################
                     0001    97 alive_type = 0x01
                     00FE    98 dead_type = 0xFE
                     00FF    99 invalid_type = 0xFF
                            100 
                            101 
                            102 ;;########################################################
                            103 ;;                       BOMB TIMERS                     #             
                            104 ;;########################################################
                     0000   105 zero_timer = 0x00
                     00FF   106 max_timer = 0xFF
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180), page 4.
Hexadecimal [16-Bits]



                              6 .include "physics_system.h.s"
                              1 ;;
                              2 ;;  PHYSICS SYSTEM HEADER
                              3 ;;
                              4 
                              5 .globl  sys_physics_init
                              6 .globl  sys_physics_update
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180), page 5.
Hexadecimal [16-Bits]



                              7 .include "render_system.h.s"
                              1 ;;
                              2 ;;  RENDER SYSTEM HEADER
                              3 ;;
                              4 
                              5 .globl  sys_render_init
                              6 .globl  sys_render_update
                              7 .globl  sys_render_remove_entity
                              8 .globl  sys_render_remove_bomb
                              9 
                             10 
                             11 ;;########################################################
                             12 ;;                       CONSTANTS                       #             
                             13 ;;########################################################
                     0000    14 video_mode = 0
                             15 
                             16 ;; in pixels
                     00A0    17 screen_width = 160
                     00C8    18 screen_height = 200
                             19 
                             20 ;;  1 byte for each +-1 Y coordinate (1px)
                             21 ;;  200px = 25 char -> 1 bomberman cell = 2height*2width chars
                             22 ;;  25chars*1cell/2char = 12 cells, rest 1 char
                             23 ;;  1 char = 8px -> so the map is centered, 4px up, 4px down
                     0004    24 min_map_y_coord_valid = 4      ;;  [0-3] border, >=4 map
                     00B3    25 max_map_y_coord_valid = 195-16    ;;  [196-199] border, <=195 map -16px
                             26 
                             27 ;;  1 byte for each +-2 X coordinate (2px)
                             28 ;;  160px = 20 char -> 1 bomberman cell = 2height*2width chars
                             29 ;;  20chars*1cell/2char = 10 cells -> 4 cells left border, 5 cells map
                             30 ;;  rest 1 cell=2 char, 1 char left border, 1 char right border
                             31 ;;  1 char = 8px -> so the map is centered, 4px up, 4px down
                             32 ;;  9 char left map, 10 char map, 1 char right map
                             33 ;;  9char*8px*1byte/2px = 36, 19char*8px*1byte/2=76
                     0024    34 min_map_x_coord_valid = 36      ;;  [0-35] border, >=35 map
                     004F    35 max_map_x_coord_valid = 79    ;;  [78-79] border, <=77 map
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180), page 6.
Hexadecimal [16-Bits]



                              8 .include "../cpct_functions.h.s"
                              1 
                              2 .globl  cpct_disableFirmware_asm
                              3 .globl  cpct_setVideoMode_asm
                              4 .globl  cpct_getScreenPtr_asm
                              5 .globl  cpct_waitVSYNC_asm
                              6 .globl  cpct_setPALColour_asm
                              7 .globl  cpct_getRandom_mxor_u8_asm
                              8 .globl  cpct_drawSpriteBlended_asm
                              9 .globl  cpct_scanKeyboard_f_asm
                             10 .globl  cpct_isKeyPressed_asm
                             11 
                             12 .globl  HW_BLACK
                             13 .globl  HW_WHITE
                             14 
                             15 .globl  CPCT_VMEM_START_ASM
                             16 .globl  Key_O
                             17 .globl  Key_P
                             18 .globl  Key_Q
                             19 .globl  Key_A
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180), page 7.
Hexadecimal [16-Bits]



                              9 
                             10 ;;########################################################
                             11 ;;                   PRIVATE FUNCTIONS                   #             
                             12 ;;########################################################
                             13 
                             14 ;;
                             15 ;;  INPUT:
                             16 ;;    ix  address memory where entity starts
                             17 ;;  RETURN: 
                             18 ;;    none
                             19 ;;  DESTROYED:
                             20 ;;    none
   0000                      21 sys_physics_update_entity::
                             22   ;; Calculate the X coordinate where the entity should be positioned and stores result in B
   0000 DD 7E 01      [19]   23   ld    a, e_x(ix)
   0003 DD 86 05      [19]   24   add   e_vx(ix)
                             25   ;add   #2
   0006 47            [ 4]   26   ld    b, a
                             27 
                             28   ;; Check is new X coordinate is greater than min allowed
                             29   ;; IF new(A)<min(B) THEN C-flag=1, new position is invalid, position is not updated
   0007 FE 24         [ 7]   30   cp    #min_map_x_coord_valid
   0009 38 0B         [12]   31   jr    c, check_y
                             32 
                             33   ;; Calculate max X coordinate where an entity could be
   000B 3E 4F         [ 7]   34   ld    a, #max_map_x_coord_valid
   000D DD 96 03      [19]   35   sub   e_w(ix)  
                             36 
                             37   ;; Check is new X coordinate is smaller than max allowed
                             38   ;; IF new(B)>max(A) THEN C-flag=1, new position is invalid, position is not updated
   0010 B8            [ 4]   39   cp    b
   0011 38 03         [12]   40   jr    c, check_y
                             41 
   0013 DD 70 01      [19]   42   ld    e_x(ix), b    ;; Update X coordinate
                             43 
   0016                      44 check_y:
                             45   ;; Calculate the Y coordinate where the entity should be positioned and stores result in B
   0016 DD 7E 02      [19]   46   ld    a, e_y(ix)
   0019 DD 86 06      [19]   47   add   e_vy(ix)
   001C 47            [ 4]   48   ld    b, a
                             49 
                             50   ;; Check is new Y coordinate is greater than min allowed
                             51   ;; IF new(A)<min(B) THEN C-flag=1, new position is invalid, position is not updated
   001D FE 04         [ 7]   52   cp    #min_map_y_coord_valid
   001F D8            [11]   53   ret   c
                             54 
                             55   ;; Calculate max X coordinate where an entity could be
   0020 3E B3         [ 7]   56   ld    a, #max_map_y_coord_valid
   0022 DD 96 04      [19]   57   sub   e_h(ix)  
                             58 
                             59   ;; Check is new Y coordinate is smaller than max allowed
                             60   ;; IF new(B)>max(A) THEN C-flag=1, new position is invalid, position is not updated
   0025 B8            [ 4]   61   cp    b
   0026 D8            [11]   62   ret   c
                             63   
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180), page 8.
Hexadecimal [16-Bits]



   0027 DD 70 02      [19]   64   ld    e_y(ix), b    ;; Update X coordinate
   002A C9            [10]   65   ret
                             66 
                             67 
                             68 ;;
                             69 ;;  INPUT:
                             70 ;;    none
                             71 ;;  RETURN: 
                             72 ;;    none
                             73 ;;  DESTROYED:
                             74 ;;    A,BC,IX
   002B                      75 sys_physics_player_update::
   002B CD 00 00      [17]   76   call  man_entity_get_player
   002E CD 00 00      [17]   77   call  sys_physics_update_entity
   0031 C9            [10]   78   ret
                             79 
                             80 
                             81 ;;
                             82 ;;  INPUT:
                             83 ;;    none
                             84 ;;  RETURN: 
                             85 ;;    none
                             86 ;;  DESTROYED:
                             87 ;;    A,BC,IX
   0032                      88 sys_physics_enemies_update::
   0032 CD 00 00      [17]   89   call  man_entity_get_enemy_array
                             90 
   0035                      91 physics_enemies_loop:
   0035 F5            [11]   92   push  af
                             93   
   0036 CD 00 00      [17]   94   call  sys_physics_update_entity
                             95 
   0039 01 09 00      [10]   96   ld    bc, #sizeof_e
   003C DD 09         [15]   97   add   ix, bc
                             98 
   003E F1            [10]   99   pop   af
   003F 3D            [ 4]  100   dec   a
   0040 C8            [11]  101   ret   z
   0041 18 F2         [12]  102   jr    physics_enemies_loop
   0043 C9            [10]  103   ret
                            104 
                            105 
                            106 ;;
                            107 ;;  INPUT:
                            108 ;;    none
                            109 ;;  RETURN: 
                            110 ;;    none
                            111 ;;  DESTROYED:
                            112 ;;    none
   0044                     113 sys_physics_bomb_update::
   0044 C9            [10]  114   ret
                            115 
                            116 
                            117 
                            118 ;;########################################################
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180), page 9.
Hexadecimal [16-Bits]



                            119 ;;                   PUBLIC FUNCTIONS                    #             
                            120 ;;########################################################
                            121 
                            122 ;;
                            123 ;;  none
                            124 ;;  INPUT:
                            125 ;;    none
                            126 ;;  RETURN: 
                            127 ;;    none
                            128 ;;  DESTROYED:
                            129 ;;    none
   0045                     130 sys_physics_init::
   0045 C9            [10]  131   ret
                            132 
                            133 
   0046                     134 sys_physics_update::
   0046 CD 2B 00      [17]  135   call  sys_physics_player_update
   0049 CD 32 00      [17]  136   call  sys_physics_enemies_update
   004C CD 44 00      [17]  137   call  sys_physics_bomb_update
   004F C9            [10]  138   ret
                            139   
